<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>Open Box</title>
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='bootstrap-responsive.min.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='bootstrap.min.css') }}">
<link href="{{ url_for('static', filename='prettify.css') }}" type="text/css" rel="stylesheet" />
<style media="screen" type="text/css">

#top-link  { display:none; position:fixed; right:14px; bottom:5px; }

</style>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename="prettify.js") }}"></script>
<script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
<script src="{{ url_for('static', filename='jquery.scrollTo-1.4.3.1-min.js') }}"></script>
<script>


$(document).ready(function () {

    function readFormValuesIntoAssArray() {
        "use strict";

        var inputs = $('#api-call :input');
        var values = {};

        $.each($('#api-call').serializeArray(), function (i, field) {
            values[field.name] = field.value;
        });

        return values;
    }

    function getParameterByName(name) {
        "use strict";

        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.search);
        if (results === null) {
            return "";
        } else {
            return decodeURIComponent(results[1].replace(/\+/g, " "));
        }
    }

    function setOauth2Tokens() {
        "use strict";

        $("#access").text("Access: " + getParameterByName("access_token"));
        $("#refresh").text("Bearer: " + getParameterByName("refresh_token"));
    }

    function redirectToBoxIfNoAuth() {
        "use strict";

        if (getParameterByName("access_token") === "") {
            window.location.replace("https://api.box.com/oauth2/authorize?response_type=code&client_id=hkwgxjpczwuakujrqcz4wh5e9kgre63i");
        }
    }

    function makeApiCall() {
        "use strict";

        $("#submit").button('loading');

        var formElements = readFormValuesIntoAssArray();
        var boxApiUrl = "https://api.box.com/2.0/";

        $.ajax({
            type: formElements.method,
            url: boxApiUrl + formElements.url,
            data: formElements.body,
            dataType: "json",
            headers: {
                "Authorization": "Bearer " + $("#access").text()
            },
            cache: false,
            statusCode: {
                401: function() {
                    $("#response").text("Unauthorized");
                    $("#http-cat").attr("src", "http://httpcats.herokuapp.com/" + "401  ");
                }
            },
            complete: function (data) {
                var formattedResponseJson = JSON.stringify($.parseJSON(data.responseText), null, '\t');
                $("#response").text(formattedResponseJson);
                $("#submit").button('reset');
                $("#response_headers").text(data.getAllResponseHeaders());
                prettyPrint();
                $("#http-cat").attr("src", "http://httpcats.herokuapp.com/" + data.status);
            }
        });
    }


    $("#url").typeahead({
        source: ["folders", "files", "collaborations", "discussions", "comments", "events", "users", "search", "shared_items",
                 "folders/ID", "files/ID", "collaborations/ID", "discussions/ID", "comments/ID", "events", "users/ID",
                 "folders/ID/items", "folders/trash/items", "users/me"]
    });

    redirectToBoxIfNoAuth();
    setOauth2Tokens();

    $("#api-call").submit(function (e) {
        e.preventDefault();
        makeApiCall();
        return false;
    });

    //set the link
    $('#top-link').topLink({
        min: 400,
        fadeSpeed: 500
    });
    //smoothscroll
    $('#top-link').click(function (e) {
        e.preventDefault();
        $.scrollTo(0, 300);
    });

});

$(document).delegate('#json_body', 'keydown', function (e) {
    var keyCode = e.keyCode || e.which;

    if (keyCode === 9) {
        e.preventDefault();
        var start = $(this).get(0).selectionStart;
        var end = $(this).get(0).selectionEnd;

        // set textarea value to: text before caret + tab + text after caret
        $(this).val($(this).val().substring(0, start) + "\t" + $(this).val().substring(end));

        // put caret at right position again
        $(this).get(0).selectionStart = $(this).get(0).selectionEnd = start + 1;
    }
});

//plugin
$.fn.topLink = function (settings) {
    settings = $.extend({
        min: 1,
        fadeSpeed: 200,
        ieOffset: 50
    }, settings);
    return this.each(function () {
        //listen for scroll
        var el = $(this);
        el.css('display', 'none'); //in case the user forgot
        $(window).scroll(function () {
            //stupid IE hack
            if (!$.support.hrefNormalized) {
                el.css({
                    'position': 'absolute',
                    'top': $(window).scrollTop() + $(window).height() - settings.ieOffset
                });
            }
            if ($(window).scrollTop() >= settings.min) {
                el.fadeIn(settings.fadeSpeed);
            } else {
                el.fadeOut(settings.fadeSpeed);
            }
        });
    });
};
</script>
</head>
<body>
<div class="container-fluid">
    <div class="navbar">
      <div class="navbar-inner">
        <a class="brand" href="#">Open Box</a>
        <ul class="nav">
            <li><a href="#">Access Token:</a></li>
            <li><a id="access" href="#"></a></li>
            <li><a href="#">Refresh Token:</a></li>
            <li><a id="refresh" href="#"></a></li>
        </ul>
      </div>
    </div>
    <div class="row-fluid">
        <fieldset>
            <form class="form span12" id="api-call" action="#" method="">
                    <div class="row-fluid">
                        <div class="span12">
                            <select class="span2" id="method" name="method">
                                <option>GET</option>
                                <option>POST</option>
                                <option>PUT</option>
                                <option>DELETE</option>
                                <option>OPTIONS</option>
                            </select>
                            <div class="input-prepend">
                                <span class="add-on">https://api.box.com/2.0/</span>
                                <input class="input-xxlarge" id="url" name="url" type="text" data-provide="typeahead" autocomplete="off" placeholder="folders/0">
                            </div>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                        <textarea id="json_body" rows="6" class="input-block-level" id="body" name="body" placeholder="JSON Body"></textarea>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <button id="submit" type="submit" class="btn btn-success btn-large btn-block">Make API Call <i class="icon-arrow-right icon-white"></i></button>
                    </div>
              </fieldset>
            </form>
        </fieldset>
    <div class="row-fluid">
        <div class="span12">
            <div class="tabbable tabs-right">
                <ul class="nav nav-tabs" id="output">
                    <li class="active"><a href="#json" data-toggle="tab">JSON</a></li>
                    <li><a href="#headers" data-toggle="tab">Headers</a></li>
                    <li><a href="#http-cat-status" data-toggle="tab">HTTP Cat</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="json">
                        <pre id="response" class="prettyprint lang-javascript"></pre>
                    </div>
                    <div class="tab-pane" id="headers">
                        <pre id="response_headers" class="prettyprint lang-javascript pre-scrollable"></pre>
                    </div>
                    <div class="tab-pane" id="http-cat-status">
                        <div class="span10">
                            <img id="http-cat" src="" class="img-rounded">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<a class="btn btn-large btn-inverse" href="#top" id="top-link"><i class="icon-chevron-up icon-white"></i></a>
</body>
</html>